name: CI

on:
  push:
    branches: [ "main", "develop", "claude/**" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read

jobs:
  test-go:
    name: Test Go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run Go tests
        run: |
          go test -v -race -cover -coverprofile=coverage.out \
            ./internal/app \
            ./internal/api/... \
            ./internal/project \
            ./internal/service \
            ./internal/resource/... \
            ./internal

      - name: Check coverage
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $coverage%"
          if (( $(echo "$coverage < 95.0" | bc -l) )); then
            echo "âŒ Coverage $coverage% is below 95%"
            exit 1
          fi
          echo "âœ… Coverage $coverage% meets requirements"

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: coverage.out
          retention-days: 30

  test-vue:
    name: Test Vue
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Vue tests
        run: npm test -- --run --coverage

      - name: Upload Vue coverage
        uses: actions/upload-artifact@v4
        with:
          name: vue-coverage
          path: web/coverage/
          retention-days: 30

  lint-go:
    name: Lint Go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

  lint-vue:
    name: Lint Vue
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npx prettier --check .

  build-go:
    name: Build Go
    runs-on: ubuntu-latest
    needs: [test-go, lint-go]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Build binary
        run: go build -v -o mahler ./cmd

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: mahler-binary-linux-amd64
          path: mahler
          retention-days: 7

  build-vue:
    name: Build Vue
    runs-on: ubuntu-latest
    needs: [test-vue, lint-vue]
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vue-dist
          path: web/dist/
          retention-days: 7

  coverage-check:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-go, test-vue]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Node dependencies
        working-directory: ./web
        run: npm ci

      - name: Run coverage check
        run: ./scripts/check-coverage.sh

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const goCoverage = await exec.getExecOutput(
              'go', ['tool', 'cover', '-func=coverage.out'],
              { ignoreReturnCode: true }
            );

            const comment = `## ðŸ“Š Coverage Report

            ### Go Coverage
            \`\`\`
            ${goCoverage.stdout}
            \`\`\`

            âœ… All coverage checks passed!
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
